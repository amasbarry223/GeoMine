// This is your Prisma schema file for GeoMine RC-Insight

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============= USERS & AUTHENTICATION =============

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  password      String?
  role          UserRole @default(VIEWER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  projects      Project[]
  auditLogs     AuditLog[]

  @@index([email])
}

enum UserRole {
  ADMIN
  PROJECT_MANAGER
  GEOPHYSICIST
  VIEWER
}

// ============= PROJECTS =============

model Project {
  id              String   @id @default(cuid())
  name            String
  description     String?
  siteLocation    String?
  gpsCoordinates  String?  // Format: "lat,lng"
  status          ProjectStatus @default(ACTIVE)
  tags            String?  // JSON array of tags
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  creator         User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  campaigns       Campaign[]

  @@index([createdBy])
  @@index([status])
  @@index([status, createdAt])
  @@index([createdAt])
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

// ============= CAMPAIGNS =============

model Campaign {
  id              String   @id @default(cuid())
  name            String
  description     String?
  projectId       String
  campaignType    CampaignType @default(GEOPHYSICS)
  startDate       DateTime?
  endDate         DateTime?
  fieldTeam       String?
  weatherConditions String?
  equipmentUsed   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  surveyLines     SurveyLine[]
  geochemicalSamples GeochemicalSample[]
  drillHoles      DrillHole[]

  @@index([projectId])
  @@index([campaignType])
}

enum CampaignType {
  GEOPHYSICS
  GEOCHEMISTRY
  DRILLING
}

// ============= SURVEY LINES =============

model SurveyLine {
  id              String   @id @default(cuid())
  name            String
  campaignId      String
  lineType        LineType
  azimuth         Float?
  dipAngle        Float?
  electrodeSpacing Float?
  numberOfElectrodes Int?
  totalLength     Float?
  topography      String?  // JSON array of [x, y, z] points
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  datasets        Dataset[]

  @@index([campaignId])
}

enum LineType {
  POLE_DIPOLE
  DIPOLE_DIPOLE
  WENNER
  SCHLUMBERGER
  POLE_POLE
}

// ============= DATASETS =============

model Dataset {
  id              String   @id @default(cuid())
  name            String
  surveyLineId    String
  dataType        DataType
  sourceFormat    String?  // CSV, TXT, RES2DINV, etc.
  fileName        String?
  fileSize        Int?
  rawData         String   // JSON: Array of data points
  metadata        String?  // JSON: Additional metadata
  isProcessed     Boolean  @default(false)
  processingHistory String? // JSON: Array of processing operations
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  surveyLine      SurveyLine @relation(fields: [surveyLineId], references: [id], onDelete: Cascade)
  preprocessedData  PreprocessedData?
  inversionModels  InversionModel[]

  @@index([surveyLineId])
  @@index([dataType])
  @@index([createdAt])
  @@index([isProcessed])
}

enum DataType {
  RESISTIVITY
  CHARGEABILITY
}

// ============= PREPROCESSED DATA =============

model PreprocessedData {
  id              String   @id @default(cuid())
  datasetId       String   @unique
  filteredData    String   // JSON: Filtered data points
  outliersRemoved String?  // JSON: Indices of removed outliers
  topographicCorrection String? // JSON: Correction data
  normalizationData String? // JSON: Normalization parameters
  filterSettings  String?  // JSON: Filter parameters used
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  dataset         Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([datasetId])
}

// ============= INVERSION MODELS =============

model InversionModel {
  id              String   @id @default(cuid())
  datasetId       String
  modelName       String
  inversionType   InversionType
  algorithm       String   @default("LEAST_SQUARES")
  iterations      Int
  rmsError        Float
  convergence     Float?
  regularizationFactor Float?
  smoothingFactor Float?
  modelParameters String  // JSON: All inversion parameters
  modelData       String   // JSON: 2D/3D model results
  qualityIndicators String? // JSON: Sensitivity, resolution, etc.
  gridGeometry    String   // JSON: Mesh/grid information
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  dataset         Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  annotations     Annotation[]

  @@index([datasetId])
  @@index([inversionType])
}

enum InversionType {
  RESISTIVITY_2D
  CHARGEABILITY_2D
  RESISTIVITY_3D
  CHARGEABILITY_3D
  JOINT_INVERSION
}

// ============= ANNOTATIONS =============

model Annotation {
  id              String   @id @default(cuid())
  inversionModelId String
  type            AnnotationType
  title           String
  description     String?
  geometry        String   // JSON: Shape data (polygon, line, point)
  properties      String?  // JSON: Additional properties
  createdBy       String?
  color           String?  // Hex color code
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  inversionModel  InversionModel @relation(fields: [inversionModelId], references: [id], onDelete: Cascade)

  @@index([inversionModelId])
}

enum AnnotationType {
  ANOMALY
  MINERALIZED_ZONE
  FAULT
  INTERPRETATION
  DRILL_TARGET
  NOTE
  MEASUREMENT
}

// ============= GIS LAYERS =============

model GISLayer {
  id              String   @id @default(cuid())
  name            String
  layerType       GISType
  projectId       String?
  fileName        String?
  filePath        String?
  format          String?  // GeoJSON, Shapefile, KML
  data            String?  // JSON: Layer data
  style           String?  // JSON: Styling information
  isVisible       Boolean  @default(true)
  zIndex          Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
  @@index([layerType])
}

enum GISType {
  GEOLOGY
  BOREHOLES
  SAMPLES
  TOPOGRAPHY
  STRUCTURES
  CUSTOM
}

// ============= REPORTS =============

model Report {
  id              String   @id @default(cuid())
  projectId       String
  name            String
  description     String?
  templateType    String?
  content         String   // JSON: Report sections and data
  includedModels  String   // JSON: Array of model IDs
  generatedAt     DateTime @default(now())
  generatedBy     String?
  fileUrl         String?  // Path to generated PDF file
  status          ReportStatus @default(DRAFT)

  @@index([projectId])
  @@index([status])
}

enum ReportStatus {
  DRAFT
  GENERATING
  COMPLETED
  FAILED
}

// ============= GEOCHEMISTRY =============

model GeochemicalSample {
  id              String   @id @default(cuid())
  campaignId      String
  holeID          String?
  sampleID        String   @unique
  surfSampleType  String?
  qcRef           String?
  dupID           String?
  sampleStatus    String?
  depth_cm        Float?
  x               Float?
  y               Float?
  z               Float?
  utmZone         String?
  surveyMethod    String?
  weathering      String?
  color            String?
  grainSize        String?
  regolith         String?
  litho1           String?
  litho2           String?
  veinType         String?
  veinAbd           String?
  sulphideType     String?
  sulphideAbd      String?
  areaDescription  String?
  operator         String?
  geologist        String?
  date             DateTime?
  comments         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  campaign         Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  assays           GeochemicalAssay[]
  
  @@index([campaignId])
  @@index([sampleID])
  @@index([holeID])
  @@index([date])
  @@index([geologist])
  @@index([weathering])
  @@index([litho1])
  @@index([sampleStatus])
}

model GeochemicalAssay {
  id              String   @id @default(cuid())
  sampleId        String
  element         String   // Au, Ag, Cu, Pb, Zn, etc.
  value           Float
  unit            String   @default("ppm")
  detectionLimit  Float?
  method          String?
  lab             String?
  labRef          String?
  createdAt       DateTime @default(now())
  
  sample          GeochemicalSample @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  
  @@index([sampleId])
  @@index([element])
  @@index([sampleId, element])
  @@index([lab])
}

// ============= DRILLING =============

model DrillHole {
  id              String   @id @default(cuid())
  campaignId      String
  holeID          String   @unique
  drillType       DrillType
  collarX         Float
  collarY         Float
  collarZ         Float
  azimuth         Float?
  dip             Float?
  totalDepth      Float?
  utmZone         String?
  startDate       DateTime?
  endDate         DateTime?
  contractor      String?
  rigType         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  surveys         DrillSurvey[]
  geology         GeologyLog[]
  assays          DrillAssay[]
  structures      StructuralMeasurement[]
  
  @@index([campaignId])
  @@index([holeID])
  @@index([drillType])
}

enum DrillType {
  ACORE
  RAB
  AUGER
  RC
  DIAMOND
}

model DrillSurvey {
  id              String   @id @default(cuid())
  drillHoleId     String
  depth           Float
  azimuth         Float?
  dip             Float?
  toolFace        Float?
  createdAt       DateTime @default(now())
  
  drillHole       DrillHole @relation(fields: [drillHoleId], references: [id], onDelete: Cascade)
  
  @@index([drillHoleId])
  @@index([depth])
}

model GeologyLog {
  id              String   @id @default(cuid())
  drillHoleId     String
  fromDepth       Float
  toDepth         Float
  lithology       String?
  alteration      String?
  mineralization  String?
  weathering      String?
  color            String?
  texture          String?
  structure        String?
  notes            String?
  geologist        String?
  logDate          DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  drillHole        DrillHole @relation(fields: [drillHoleId], references: [id], onDelete: Cascade)
  
  @@index([drillHoleId])
  @@index([fromDepth, toDepth])
  @@index([lithology])
  @@index([geologist])
  @@index([logDate])
}

model DrillAssay {
  id              String   @id @default(cuid())
  drillHoleId     String
  sampleID         String?
  fromDepth        Float
  toDepth          Float
  element          String
  value            Float
  unit             String   @default("ppm")
  detectionLimit   Float?
  method           String?
  lab              String?
  createdAt        DateTime @default(now())
  
  drillHole        DrillHole @relation(fields: [drillHoleId], references: [id], onDelete: Cascade)
  
  @@index([drillHoleId])
  @@index([sampleID])
  @@index([element])
  @@index([fromDepth, toDepth])
}

model StructuralMeasurement {
  id              String   @id @default(cuid())
  drillHoleId     String
  depth            Float
  direction        Float   // Azimuth en degrés
  dip              Float   // Plongement en degrés
  structureType    String? // Faille, joint, foliation, etc.
  description      String?
  geologist        String?
  measurementDate  DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  drillHole        DrillHole @relation(fields: [drillHoleId], references: [id], onDelete: Cascade)
  
  @@index([drillHoleId])
  @@index([depth])
}

// ============= AUDIT LOG =============

model AuditLog {
  id              String   @id @default(cuid())
  userId          String?
  action          String
  entityType      String
  entityId        String?
  details         String?  // JSON: Additional details
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}
